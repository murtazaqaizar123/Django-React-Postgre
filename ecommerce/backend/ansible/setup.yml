---
- name: Setup and deploy Django + React project
  hosts: localhost
  become: true

  vars:
    project_root: /var/lib/jenkins/workspace/Django-React-Postgre/ecommerce/backend
    backend_dir: "{{ project_root }}"
    frontend_dir: "{{ backend_dir }}/frontend"
    venv_path: "{{ backend_dir }}/venv"

  tasks:
    - name: Update APT cache
      apt:
        update_cache: yes

    - name: Install core system dependencies
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - postgresql
          - postgresql-contrib
          - curl
          - nginx
        state: present

    - name: Download Node.js 18 setup script
      command: curl -fsSL https://deb.nodesource.com/setup_18.x -o nodesource_setup.sh
      args:
        chdir: /tmp

    - name: Run Node.js 18 setup script
      command: bash nodesource_setup.sh
      args:
        chdir: /tmp

    - name: Install Node.js (includes npm)
      apt:
        name: nodejs
        state: present

    - name: Install Yarn globally
      npm:
        name: yarn
        global: yes

    - name: Create Python virtual environment
      command: python3 -m venv "{{ venv_path }}"
      args:
        creates: "{{ venv_path }}"

    - name: Install Python requirements
      pip:
        requirements: "{{ backend_dir }}/requirements.txt"
        virtualenv: "{{ venv_path }}"
        virtualenv_command: python3 -m venv

    - name: Run Django migrations
      command: "{{ venv_path }}/bin/python manage.py migrate"
      args:
        chdir: "{{ backend_dir }}"

    - name: Collect static files
      command: "{{ venv_path }}/bin/python manage.py collectstatic --noinput"
      args:
        chdir: "{{ backend_dir }}"

    - name: Install frontend dependencies
      command: yarn install
      args:
        chdir: "{{ frontend_dir }}"

    - name: Build frontend
      command: yarn build
      args:
        chdir: "{{ frontend_dir }}"
